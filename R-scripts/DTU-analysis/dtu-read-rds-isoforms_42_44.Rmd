---
title: "Differential Transcript Expression of 42 vs 44 colorectal cancer samples in R"
author: "Salomón Marquez"
date: "`r Sys.Date()`"
output:
   html_document:
    code_folding: hide
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
    toc_depth: 3
    number_sections: true
    self-contained: true
#output:
#   pdf_document:
#   latex_engine: xelatex  # o lualatex
#   keep_tex: yes
#   toc: yes
editor_options: 
  markdown: 
    wrap: 72
#editor_options: 
#  chunk_output_type: console
---

```{r setup, include=FALSE}
# Load knitr
library(knitr)

# Global R options
options(max.print = 50)
options(repos = c(CRAN = "https://cloud.r-project.org")) 

# Global chunk options
opts_chunk$set(
  echo = TRUE,     # show code
  cache = TRUE,    # caching
  prompt = FALSE,   # don’t show ">" in code
  tidy = TRUE,      # clean code formatting
  comment = NA,     # no extra comment symbols
  message = FALSE,  # hide package load messages
  warning = FALSE   # hide warnings
)

# Knitr rendering width
opts_knit$set(width = 100)
```

```{r, include=FALSE}
# Install and load modules and libraries 
library(skimr)
library(scales)
library(ggplot2)
library(tidyr)
library(dplyr)
library(S4Vectors)
library(reshape2)
library(ggfortify)
library(corrplot)
library(factoextra)

library(SummarizedExperiment)
library(DESeq2)
library(IsoformSwitchAnalyzeR)
library(tidyverse)
library(dbplyr)
library(BiocParallel)
library(Biostrings)
```

# Load dataset

Let's ensure that the previously mentioned file are in our working
directory.

```{r}
# Specify a working directory
directory <- "/Volumes/DataWinBackup/00_MASTER UOC BIOINFORMATICA - TEMPORAL/TFM-UOC/DTU44CRC"
setwd(directory)
list.files()
```

```{r}
# Load file
mySwitchList <- readRDS("mySwitchList_consequences_42_44.rds")

# [1] "aSwitchList" "counts"      "directory"   "myDesign"    "tpm"  
```

```{r}
# View salmonQuant
names(mySwitchList)
head(mySwitchList, 3) 
```

```{r}
# Summary
mySwitchList$isoformFeatures
```

# Review mySwithList object

```{r}
# Summary
extractSwitchSummary(mySwitchList, filterForConsequences = T)
```

```{r}
# Summary
extractSwitchSummary(
    mySwitchList,
    filterForConsequences=TRUE,
    alpha=0.05,
    dIFcutoff = 0.05
)
```


```{r, echo=FALSE}
switch_summary <- extractSwitchSummary(
    mySwitchList,
    filterForConsequences=TRUE,
    alpha=0.05,
    dIFcutoff = 0.05
)

# Export table to .tex format
table_tex <- kable(
  switch_summary,
  format = "latex",
  booktabs = TRUE,
  linesep = ""
)

writeLines(table_tex, "tables/switch_summary.tex")
```

```{r, extractSwitchOverlap_isoform_switch_genes, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Genome-wide Summaries
extractSwitchOverlap(
    mySwitchList,
    filterForConsequences=TRUE,    
    alpha = 0.05,
    dIFcutoff = 0.05,
)
```

```{r top_switch_genes}
# Extract top switching genes (by q-value) from each comparison 
top_switch_genes <- extractTopSwitches(
    mySwitchList,
    filterForConsequences=TRUE,
    extractGenes=TRUE,
    alpha=0.05,
    dIFcutoff = 0.05,
    n=109,
    inEachComparison=FALSE,
    sortByQvals=TRUE
)

keep <- c("gene_id", "condition_1", "condition_2", "gene_switch_q_value", "Rank")
top_switch_genes <- top_switch_genes[keep]
top_switch_genes

# Save results
write.csv(top_switch_genes, "top_switch_genes.csv")
```

```{r, echo=FALSE}
# Export table to .tex format
table_tex <- kable(
  top_switch_genes,
  format = "latex",
  booktabs = TRUE,
  linesep = ""
)

writeLines(table_tex, "tables/top_switch_genes_from_each_comparison.tex")
```

```{r top_isoforms}
# Extract top switching genes (by q-value) from each comparison 
top_switch_isoforms <- extractTopSwitches(
    mySwitchList,
    filterForConsequences=TRUE,
    extractGenes=FALSE,
    alpha=0.05,
    dIFcutoff = 0.05,
    n=148,
    inEachComparison=FALSE,
    sortByQvals=TRUE
)

keep <- c("isoform_id","gene_id", "condition_1", "condition_2", "dIF", "isoform_switch_q_value", "Rank")
top_switch_isoforms <- top_switch_isoforms[keep]
top_switch_isoforms

# Save results
write.csv(top_switch_isoforms, "top_switch_isoforms.csv")
```

```{r, echo=FALSE}
# Export table to .tex format
table_tex <- kable(
  top_switch_isoforms,
  format = "latex",
  booktabs = TRUE,
  linesep = ""
)

writeLines(table_tex, "tables/top_isoforms_from_each_comparison.tex")
```

# Analysis of Individual Isoform Switching

```{r, include=FALSE}
# Visualize gene transcripts variants
switchPlotTranscript(mySwitchList, gene="TPM2") 
```

```{r, include=FALSE}
# Visualizes the gene expression
switchPlotGeneExp(mySwitchList, gene="TPM2", condition1 = 'normal_eocrc',condition2 = 'tumor_eocrc', localTheme = theme_bw(base_size = 9)) 
```

```{r, include=FALSE}
# Visualizes the gene expression
switchPlotIsoExp(mySwitchList, gene="TPM2", condition1 = 'normal_eocrc',condition2 = 'tumor_eocrc', localTheme = theme_bw(base_size = 9)) 
```

```{r, include=FALSE}
# Visualizes the isoform usage 
switchPlotIsoUsage(mySwitchList, gene="TPM2", condition1 = 'normal_eocrc',condition2 = 'tumor_eocrc', localTheme = theme_bw(base_size = 9)) 
```

## Top 3 EOCRC switch genes

```{r, isoform_switch_tpm2_eocrc_a, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="TPM2", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_tcea2, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="TCEA2", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_linc01559, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="LINC01559", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

## Top 3 LOCRC switch genes

```{r, isoform_switch_sorbs2, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="SORBS2", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_tpm2_locrc_a, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="TPM2", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_fsip1, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="FSIP1", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_osbpl1a, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="OSBPL1A", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

# Genes with overlapped isoforms 

```{r, isoform_switch_tpm2_eocrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="TPM2", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_tpm2_locrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="TPM2", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_lmnb2_eocrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="LMNB2", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_lmnb2_locrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="LMNB2", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_map3k20_eocrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="MAP3K20", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_map3k20_locrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="MAP3K20", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_hoxb-as3_eocrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="HOXB-AS3", 
           condition1 = 'normal_eocrc', 
           condition2 = 'tumor_eocrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

```{r, isoform_switch_hoxb-as3_locrc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Summary
switchPlot(mySwitchList, 
           gene="HOXB-AS3", 
           condition1 = 'normal_locrc', 
           condition2 = 'tumor_locrc', 
           localTheme = theme_bw(base_size = 7), 
           plotTopology=FALSE)  
```

# Genome-wide Summaries

```{r, extract_splicing_summary, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Genome-Wide Analysis of Alternative Splicing
extractSplicingSummary_df <- extractSplicingSummary(
    mySwitchList,
    localTheme = theme_bw(base_size = 7),
    returnResult = TRUE # if TRUE returns a data.frame with the summary statistics   
)

write.csv(extractSplicingSummary_df, "extractSplicingSummary.csv", row.names = FALSE)

```

```{r, extract_consequence_summary, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Genome-wide Summaries
extractConsequenceSummary_df <- extractConsequenceSummary(
    mySwitchList,
    consequencesToAnalyze="all",
    plotGenes = FALSE,           # enables analysis of genes (instead of isoforms)
    asFractionTotal = FALSE,     # enables analysis of fraction of significant features
    localTheme = theme_bw(base_size = 7),
    returnResult=TRUE
)

write.csv(extractConsequenceSummary_df, "extractConsequenceSummary.csv", row.names = FALSE)
```

## Consequence Enrichment Analysis

```{r, extract_consequence_enrichment, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
extractConsequenceEnrichment(
    mySwitchList,
    consequencesToAnalyze='all',
    countGenes = FALSE,
    analysisOppositeConsequence = TRUE,
    localTheme = theme_bw(base_size = 14), 
    returnResult = TRUE 
)
```

```{r, extract_consequence_enrichment_comparison, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
extractConsequenceEnrichmentComparison_df <- extractConsequenceEnrichmentComparison(
    mySwitchList,
    consequencesToAnalyze='all',
    countGenes = FALSE,
    analysisOppositeConsequence = TRUE,
    localTheme = theme_bw(base_size = 8), 
    returnResult = TRUE 
)

write.csv(extractConsequenceEnrichmentComparison_df, "extractConsequenceEnrichmentComparison.csv", row.names = FALSE)
```

## Splicing Enrichment Analysis

```{r, extract_splicing_enrichment, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
extractSplicingEnrichment(
    mySwitchList,
    returnResult = TRUE # if TRUE returns a data.frame with the summary statistics
)
```

```{r, extract_splicing_enrichment_comparison, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
extractSplicingEnrichmentComparison_df <- extractSplicingEnrichmentComparison(
    mySwitchList,
    splicingToAnalyze = c('A3','A5','ATSS','ATTS'), # the splicing highlighted above
    localTheme = theme_bw(base_size = 8),
    returnResult = TRUE # if TRUE returns a data.frame with the results
)

write.csv(extractSplicingEnrichmentComparison_df, "extractSplicingEnrichmentComparison.csv", row.names = FALSE)
```

```{r, extract_splicing_genomewide, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
extractSplicingGenomeWide_df <- extractSplicingGenomeWide(
    mySwitchList,
    localTheme = theme_bw(base_size = 8),
    returnResult = TRUE # if TRUE returns a data.frame with the summary statistics
)

write.csv(extractSplicingGenomeWide_df, "extractSplicingGenomeWide.csv", row.names = FALSE)
```

## Overview Plots

```{r, volcano_isoform_switch, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Volcano like plot:
ggplot(data=mySwitchList$isoformFeatures, aes(x=dIF, y=-log10(isoform_switch_q_value))) +
     geom_point(
        aes( color=abs(dIF) > 0.05 & isoform_switch_q_value < 0.05 ), # default cutoff
        size=1
    ) +
    geom_hline(yintercept = -log10(0.05), linetype='dashed') + # default cutoff
    geom_vline(xintercept = c(-0.05, 0.05), linetype='dashed') + # default cutoff
    facet_wrap( ~ condition_2) +
    #facet_grid(condition_1 ~ condition_2) + # alternative to facet_wrap if overlapping conditions
    scale_color_manual('Signficant\nIsoform Switch', values = c('black','red')) +
    labs(x='dIF', y='-Log10 ( Isoform Switch Q Value )') +
    theme_bw()
```

```{r, volcano_isoform_switch_lfc, echo=FALSE, fig.width=8.0, fig.height=4.0, dev="pdf", fig.path="figures/", fig.ext="pdf"}
# Switch vs Gene changes:
ggplot(data=mySwitchList$isoformFeatures, aes(x=gene_log2_fold_change, y=dIF)) +
    geom_point(
        aes( color=abs(dIF) > 0.05 & isoform_switch_q_value < 0.05 ), # default cutoff
        size=1
    ) + 
    facet_wrap(~ condition_2) +
    #facet_grid(condition_1 ~ condition_2) + # alternative to facet_wrap if overlapping conditions
    geom_hline(yintercept = 0, linetype='dashed') +
    geom_vline(xintercept = 0, linetype='dashed') +
    scale_color_manual('Signficant\nIsoform Switch', values = c('black','red')) +
    labs(x='Gene log2 fold change', y='dIF') +
    theme_bw()
```


# Analysis of overlapped isoforms

```{r}
# Extract gene data
overlapGenes <- c("TPM2", "LMNB2", "MAP3K20", "HOXB-AS3")

four_genes_data <- mySwitchList$isoformFeatures %>%
    dplyr::filter(
        gene_name %in% overlapGenes,          
        isoform_switch_q_value < 0.05, 
        abs(dIF) > 0.05
    ) %>%
    dplyr::select(
        isoform_id,
        gene_name,
        iso_biotype,
        condition_1,
        condition_2,
        dIF,
        isoform_switch_q_value,
        gene_switch_q_value,
        gene_log2_fold_change
    ) %>%
    dplyr::arrange(isoform_switch_q_value) %>%
    
    # Add information 
    dplyr::mutate(
        direction = ifelse(dIF > 0, "Up in tumor", "Down in tumor")
    )

# View results
print(four_genes_data)

```
```{r}
# Save results
# Format decimals of top_genes dataframe
format_numeric <- function(x) {
  if (is.numeric(x)) {
    formatted <- ifelse(abs(x) < 0.001 & !is.na(x), 
                       formatC(x, format = "e", digits = 2),
                       as.character(round(x, 4)))
    return(formatted)
  } else {
    return(x)
  }
}

# Apply format_numeric function 
four_genes_data_formatted <- four_genes_data %>%
  mutate(across(where(is.numeric), format_numeric))
four_genes_data_formatted

# Export table to .tex format
table_tex <- kable(
  four_genes_data_formatted,
  format = "latex",
  booktabs = TRUE,
  linesep = ""
)

writeLines(table_tex, "tables/6_shared_isoforms.tex")
```


```{r}
# library(dplyr)
# 
# overlapGenes <- c("TPM2", "LMNB2", "MAP3K20", "HOXB-AS3")
# 
# # Extraer todos los parámetros con los nombres correctos
# all_parameters <- mySwitchList$isoformFeatures %>%
#     dplyr::filter(gene_name %in% overlapGenes,
#                   isoform_switch_q_value < 0.05, 
#                   abs(dIF) > 0.05) %>%
#     dplyr::select(
#         # =========== IDENTIFICADORES ===========
#         isoform_id,
#         gene_id,
#         gene_name,
#         gene_biotype,
#         iso_biotype,
#         
#         # =========== CONDICIONES ===========
#         condition_1,
#         condition_2,
#         
#         # =========== 1. GENE EXPRESSION ===========
#         # Expresión génica total
#         gene_exp_cond1 = gene_value_1,        # Normal
#         gene_exp_cond2 = gene_value_2,        # Tumor
#         gene_overall_mean,                    # Promedio general
#         gene_stderr_1,                        # Error estándar cond1
#         gene_stderr_2,                        # Error estándar cond2
#         gene_log2_fold_change,                # Log2FC del gen
#         gene_q_value,                         # q-value del gen
#         
#         # =========== 2. ISOFORM EXPRESSION ===========
#         # Expresión por isoforma
#         iso_exp_cond1 = iso_value_1,          # Normal
#         iso_exp_cond2 = iso_value_2,          # Tumor
#         iso_overall_mean,                     # Promedio general
#         iso_stderr_1,                         # Error estándar cond1
#         iso_stderr_2,                         # Error estándar cond2
#         iso_log2_fold_change,                 # Log2FC del isoforma
#         iso_q_value,                          # q-value del isoforma
#         
#         # =========== 3. ISOFORM USAGE ===========
#         # Uso/fracción de isoforma
#         IF_overall,                           # Fracción general
#         IF_cond1 = IF1,                       # Fracción en condición 1 (0-1)
#         IF_cond2 = IF2,                       # Fracción en condición 2 (0-1)
#         dIF,                                  # Cambio en fracción: IF2 - IF1
#         
#         # =========== SIGNIFICANCIA SWITCHING ===========
#         isoform_switch_q_value,
#         gene_switch_q_value,
#         
#         # =========== CARACTERÍSTICAS ADICIONALES ===========
#         PTC,                                  # Premature Termination Codon
#         IR,                                   # Intron Retention
#         switchConsequencesGene                # Consecuencias del switching
#     ) %>%
#     # =========== CÁLCULOS DERIVADOS ===========
#     dplyr::mutate(
#         # Fold changes lineales (a partir de log2FC)
#         gene_fold_change = 2^gene_log2_fold_change,
#         iso_fold_change = 2^iso_log2_fold_change,
#         
#         # Significancia de expresión génica
#         gene_expr_sig = gene_q_value < 0.05,
#         
#         # Significancia de expresión de isoforma
#         iso_expr_sig = iso_q_value < 0.05,
#         
#         # Significancia de switching
#         switching_sig = isoform_switch_q_value < 0.05 & abs(dIF) > 0.05,
#         
#         # Dirección del switching
#         switching_direction = case_when(
#             dIF > 0.1 & isoform_switch_q_value < 0.05 ~ "Significant Increase",
#             dIF < -0.1 & isoform_switch_q_value < 0.05 ~ "Significant Decrease",
#             isoform_switch_q_value < 0.05 ~ "Significant Small Change",
#             TRUE ~ "Non-significant"
#         ),
#         
#         # Clasificación por contribución
#         isoform_contribution_cond1 = (iso_exp_cond1 / gene_exp_cond1) * 100,
#         isoform_contribution_cond2 = (iso_exp_cond2 / gene_exp_cond2) * 100,
#         
#         # Cambio en contribución
#         contribution_change = isoform_contribution_cond2 - isoform_contribution_cond1,
#         
#         # Dominancia
#         dominance = case_when(
#             IF_cond1 > 0.7 & IF_cond2 > 0.7 ~ "Major in Both",
#             IF_cond1 > 0.7 ~ "Major in Normal",
#             IF_cond2 > 0.7 ~ "Major in Tumor",
#             IF_cond1 > 0.5 | IF_cond2 > 0.5 ~ "Intermediate",
#             TRUE ~ "Minor"
#         )
#     ) %>%
#     # =========== ORDENAR ===========
#     dplyr::arrange(gene_name, isoform_switch_q_value, desc(abs(dIF)))
# 
# # Ver las primeras filas
# print(all_parameters, n = 15)
# 
# write.csv(all_parameters, "all_parameters_isoforms.csv", row.names = FALSE)
```

# R Session Information 

```{r, echo=FALSE}
# Session info
devtools::session_info()
```
