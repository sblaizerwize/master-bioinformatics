// ============================================================
// UNAVCLUSTER PROFILE â€” optimized for nf-core pipelines on SLURM
// ============================================================

profiles {
  unavcluster {

    // ---------------------------
    // Container runtime settings
    // ---------------------------
    singularity {
      enabled = true
      autoMounts = true
      cacheDir = 'singularity_images'
    }

    // ---------------------------
    // Process execution defaults
    // ---------------------------
    process {
      executor = 'slurm'
      queueSize = 50                          // Maximum concurrent queued jobs
      queue = { task.memory <= 48.GB ? 'short' : 'medium' }

      scratch = true
      cpus = 4
      memory = 8.GB
      time = '4h'
      maxRetries = 2
      errorStrategy = 'retry'

      // Hard resource caps (safety net)
      resourceLimits = [
        memory: 128.GB,
        cpus: 32,
        time: 72.h
      ]

      // Retry for transient or memory errors
      errorStrategy = { 
        task.exitStatus in [143, 137, 104, 134, 139, 140] ? 'retry' : 'finish' 
      }
      maxErrors = 5
      maxRetries = 3

      // Dynamic memory scaling: retry with more RAM if job fails
      memory = { 
        def baseMem = 8.GB
        return baseMem * task.attempt
      }

      // ---------------------------
      // Process-specific overrides
      // ---------------------------
      withName: 'TRIMGALORE' {
        cpus = 4
        memory = { 8.GB * task.attempt }
        time = '1h'
      }

      withName: 'KALLISTO_QUAN' {
        cpus = 8
        memory = { 24.GB * task.attempt }
        time = '3h'
      }

      withName: 'SALMON_INDEX' {
        cpus = 16
        memory = { 32.GB * task.attempt }
        time = '6h'
      }

      withName: 'SALMON_QUANT' {
        cpus = 8
        memory = { 24.GB * task.attempt }
        time = '4h'
      }
    }

    // ---------------------------
    // Reports and logging
    // ---------------------------
    report {
      enabled = true
      file = 'reports/report.html'
    }

    timeline {
      enabled = true
      file = 'reports/timeline.html'
    }

    trace {
      enabled = true
      file = 'reports/trace.txt'
    }

    dag {
      enabled = true
      file = 'reports/flowchart.png'
    }
  }
}
